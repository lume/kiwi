
/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2019, Nucleic Development Team & H. Rutjes & Lume.
|
| Distributed under the terms of the Modified BSD License.
|
| The full license is in the file COPYING.txt, distributed with this software.
-----------------------------------------------------------------------------*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).kiwi={})}(this,function(d){"use strict";function f(){return new t}i.prototype.size=function(){return this.array.length},i.prototype.empty=function(){return 0===this.array.length},i.prototype.itemAt=function(t){return this.array[t]},i.prototype.contains=function(t){return void 0!==this.index[t.id()]},i.prototype.find=function(t){t=this.index[t.id()];return void 0===t?void 0:this.array[t]},i.prototype.setDefault=function(t,e){var r=this.index[t.id()];return void 0===r?(e=new o(t,e()),this.index[t.id()]=this.array.length,this.array.push(e),e):this.array[r]},i.prototype.insert=function(t,e){var e=new o(t,e),r=this.index[t.id()];return void 0===r?(this.index[t.id()]=this.array.length,this.array.push(e)):this.array[r]=e,e},i.prototype.erase=function(t){var e,r=this.index[t.id()];if(void 0!==r)return this.index[t.id()]=void 0,(t=this.array[r])!==(e=this.array.pop())&&(this.array[r]=e,this.index[e.first.id()]=r),t},i.prototype.copy=function(){for(var t=new i,e=0;e<this.array.length;e++){var r=this.array[e].copy();t.array[e]=r,t.index[r.first.id()]=e}return t};var t=i;function i(){this.index={},this.array=[]}e.prototype.copy=function(){return new e(this.first,this.second)};var o=e;function e(t,e){this.first=t,this.second=e}r.prototype.id=function(){return this._id},r.prototype.name=function(){return this._name},r.prototype.setName=function(t){this._name=t},r.prototype.context=function(){return this._context},r.prototype.setContext=function(t){this._context=t},r.prototype.value=function(){return this._value},r.prototype.setValue=function(t){this._value=t},r.prototype.plus=function(t){return new y(this,t)},r.prototype.minus=function(t){return new y(this,"number"==typeof t?-t:[-1,t])},r.prototype.multiply=function(t){return new y([t,this])},r.prototype.divide=function(t){return new y([1/t,this])},r.prototype.toJSON=function(){return{name:this._name,value:this._value}},r.prototype.toString=function(){return this._context+"["+this._name+":"+this._value+"]"};var l=r;function r(t){void 0===t&&(t=""),this._value=0,this._context=null,this._id=n++,this._name=t}var n=0,y=(s.prototype.terms=function(){return this._terms},s.prototype.constant=function(){return this._constant},s.prototype.value=function(){for(var t=this._constant,e=0,r=this._terms.size();e<r;e++){var i=this._terms.itemAt(e);t+=i.first.value()*i.second}return t},s.prototype.plus=function(t){return new s(this,t)},s.prototype.minus=function(t){return new s(this,"number"==typeof t?-t:[-1,t])},s.prototype.multiply=function(t){return new s([t,this])},s.prototype.divide=function(t){return new s([1/t,this])},s.prototype.isConstant=function(){return 0==this._terms.size()},s.prototype.toString=function(){var t=this._terms.array.map(function(t){return t.second+"*"+t.first.toString()}).join(" + ");return this.isConstant()||0===this._constant||(t+=" + "),t+=this._constant},s);function s(){var t=function(t){for(var e=0,r=function(){return 0},i=f(),o=0,n=t.length;o<n;++o){var s=t[o];if("number"==typeof s)e+=s;else if(s instanceof l)i.setDefault(s,r).second+=1;else if(s instanceof y){e+=s.constant();for(var a=s.terms(),c=0,p=a.size();c<p;c++){var u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second}}else{if(!(s instanceof Array))throw new Error("invalid Expression argument: "+s);if(2!==s.length)throw new Error("array must have length 2");var h=s[0],s=s[1];if("number"!=typeof h)throw new Error("array item 0 must be a number");if(s instanceof l)i.setDefault(s,r).second+=h;else{if(!(s instanceof y))throw new Error("array item 1 must be a variable or expression");e+=s.constant()*h;for(a=s.terms(),c=0,p=a.size();c<p;c++){u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second*h}}}}return{terms:i,constant:e}}(arguments);this._terms=t.terms,this._constant=t.constant}a.create=function(t,e,r,i){void 0===i&&(i=1);var o=0;return(o+=1e6*Math.max(0,Math.min(1e3,t*i)))+1e3*Math.max(0,Math.min(1e3,e*i))+Math.max(0,Math.min(1e3,r*i))},a.clip=function(t){return Math.max(0,Math.min(a.required,t))},a.required=a.create(1e3,1e3,1e3),a.strong=a.create(1,0,0),a.medium=a.create(0,1,0),a.weak=a.create(0,0,1);var v=a;function a(){}(m=d.Operator||(d.Operator={}))[m.Le=0]="Le",m[m.Ge=1]="Ge",m[m.Eq=2]="Eq";p.prototype.id=function(){return this._id},p.prototype.expression=function(){return this._expression},p.prototype.op=function(){return this._operator},p.prototype.strength=function(){return this._strength},p.prototype.toString=function(){return this._expression.toString()+" "+["<=",">=","="][this._operator]+" 0 ("+this._strength.toString()+")"};var c=p;function p(t,e,r,i){void 0===i&&(i=v.required),this._id=h++,this._operator=e,this._strength=v.clip(i),void 0===r&&t instanceof y?this._expression=t:this._expression=t.minus(r)}var _,u,h=0,m=(b.prototype.createConstraint=function(t,e,r,i){void 0===i&&(i=v.required);t=new c(t,e,r,i);return this.addConstraint(t),t},b.prototype.addConstraint=function(t){if(void 0!==this._cnMap.find(t))throw new Error("duplicate constraint");var e=this._createRow(t),r=e.row,e=e.tag,i=this._chooseSubject(r,e);if(i.type()===_.Invalid&&r.allDummies()){if(!w(r.constant()))throw new Error("unsatisfiable constraint");i=e.marker}if(i.type()===_.Invalid){if(!this._addWithArtificialVariable(r))throw new Error("unsatisfiable constraint")}else r.solveFor(i),this._substitute(i,r),this._rowMap.insert(i,r);this._cnMap.insert(t,e),this._optimize(this._objective)},b.prototype.removeConstraint=function(t){var e=this._cnMap.erase(t);if(void 0===e)throw new Error("unknown constraint");this._removeConstraintEffects(t,e.second);t=e.second.marker,e=this._rowMap.erase(t);if(void 0===e){var r=this._getMarkerLeavingSymbol(t);if(r.type()===_.Invalid)throw new Error("failed to find leaving row");(e=this._rowMap.erase(r)).second.solveForEx(r,t),this._substitute(t,e.second)}this._optimize(this._objective)},b.prototype.hasConstraint=function(t){return this._cnMap.contains(t)},b.prototype.addEditVariable=function(t,e){if(void 0!==this._editMap.find(t))throw new Error("duplicate edit variable");if((e=v.clip(e))===v.required)throw new Error("bad required strength");var r=new y(t),r=new c(r,d.Operator.Eq,void 0,e),e=(this.addConstraint(r),this._cnMap.find(r).second);this._editMap.insert(t,{tag:e,constraint:r,constant:0})},b.prototype.removeEditVariable=function(t){t=this._editMap.erase(t);if(void 0===t)throw new Error("unknown edit variable");this.removeConstraint(t.second.constraint)},b.prototype.hasEditVariable=function(t){return this._editMap.contains(t)},b.prototype.suggestValue=function(t,e){t=this._editMap.find(t);if(void 0===t)throw new Error("unknown edit variable");var r=this._rowMap,t=t.second,i=e-t.constant,o=(t.constant=e,t.tag.marker);if(void 0!==(e=r.find(o)))e.second.add(-i)<0&&this._infeasibleRows.push(o);else if(t=t.tag.other,void 0!==(e=r.find(t)))e.second.add(i)<0&&this._infeasibleRows.push(t);else for(var n=0,s=r.size();n<s;++n){var a=r.itemAt(n),c=a.second,p=c.coefficientFor(o);0!==p&&c.add(i*p)<0&&a.first.type()!==_.External&&this._infeasibleRows.push(a.first)}this._dualOptimize()},b.prototype.updateVariables=function(){for(var t=this._varMap,e=this._rowMap,r=0,i=t.size();r<i;++r){var o=t.itemAt(r),n=e.find(o.second);void 0!==n?o.first.setValue(n.second.constant()):o.first.setValue(0)}},b.prototype._getVarSymbol=function(t){var e=this;return this._varMap.setDefault(t,function(){return e._makeSymbol(_.External)}).second},b.prototype._createRow=function(t){for(var e=t.expression(),r=new g(e.constant()),i=e.terms(),o=0,n=i.size();o<n;++o){var s,a,c=i.itemAt(o);w(c.second)||(s=this._getVarSymbol(c.first),void 0!==(a=this._rowMap.find(s))?r.insertRow(a.second,c.second):r.insertSymbol(s,c.second))}var p=this._objective,u=t.strength(),h={marker:S,other:S};switch(t.op()){case d.Operator.Le:case d.Operator.Ge:var f=t.op()===d.Operator.Le?1:-1,l=this._makeSymbol(_.Slack);r.insertSymbol(h.marker=l,f),u<v.required&&(l=this._makeSymbol(_.Error),r.insertSymbol(h.other=l,-f),p.insertSymbol(l,u));break;case d.Operator.Eq:u<v.required?(f=this._makeSymbol(_.Error),l=this._makeSymbol(_.Error),h.marker=f,h.other=l,r.insertSymbol(f,-1),r.insertSymbol(l,1),p.insertSymbol(f,u),p.insertSymbol(l,u)):(f=this._makeSymbol(_.Dummy),r.insertSymbol(h.marker=f))}return r.constant()<0&&r.reverseSign(),{row:r,tag:h}},b.prototype._chooseSubject=function(t,e){for(var r=t.cells(),i=0,o=r.size();i<o;++i){var n=r.itemAt(i);if(n.first.type()===_.External)return n.first}var s=e.marker.type();return(s===_.Slack||s===_.Error)&&t.coefficientFor(e.marker)<0?e.marker:((s=e.other.type())===_.Slack||s===_.Error)&&t.coefficientFor(e.other)<0?e.other:S},b.prototype._addWithArtificialVariable=function(t){var e=this._makeSymbol(_.Slack),t=(this._rowMap.insert(e,t.copy()),this._artificial=t.copy(),this._optimize(this._artificial),w(this._artificial.constant())),r=(this._artificial=null,this._rowMap.erase(e));if(void 0!==r){r=r.second;if(r.isConstant())return t;var i=this._anyPivotableSymbol(r);if(i.type()===_.Invalid)return!1;r.solveForEx(e,i),this._substitute(i,r),this._rowMap.insert(i,r)}for(var o=this._rowMap,n=0,s=o.size();n<s;++n)o.itemAt(n).second.removeSymbol(e);return this._objective.removeSymbol(e),t},b.prototype._substitute=function(t,e){for(var r=this._rowMap,i=0,o=r.size();i<o;++i){var n=r.itemAt(i);n.second.substitute(t,e),n.second.constant()<0&&n.first.type()!==_.External&&this._infeasibleRows.push(n.first)}this._objective.substitute(t,e),this._artificial&&this._artificial.substitute(t,e)},b.prototype._optimize=function(t){for(var e=0;e<this.maxIterations;){var r=this._getEnteringSymbol(t);if(r.type()===_.Invalid)return;var i=this._getLeavingSymbol(r);if(i.type()===_.Invalid)throw new Error("the objective is unbounded");var o=this._rowMap.erase(i).second;o.solveForEx(i,r),this._substitute(r,o),this._rowMap.insert(r,o),e++}throw new Error("solver iterations exceeded")},b.prototype._dualOptimize=function(){for(var t=this._rowMap,e=this._infeasibleRows;0!==e.length;){var r=e.pop(),i=t.find(r);if(void 0!==i&&i.second.constant()<0){var o=this._getDualEnteringSymbol(i.second);if(o.type()===_.Invalid)throw new Error("dual optimize failed");i=i.second;t.erase(r),i.solveForEx(r,o),this._substitute(o,i),t.insert(o,i)}}},b.prototype._getEnteringSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var o=e.itemAt(r),n=o.first;if(o.second<0&&n.type()!==_.Dummy)return n}return S},b.prototype._getDualEnteringSymbol=function(t){for(var e=Number.MAX_VALUE,r=S,i=t.cells(),o=0,n=i.size();o<n;++o){var s=i.itemAt(o),a=s.first,s=s.second;0<s&&a.type()!==_.Dummy&&(s=this._objective.coefficientFor(a)/s)<e&&(e=s,r=a)}return r},b.prototype._getLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=S,i=this._rowMap,o=0,n=i.size();o<n;++o){var s,a=i.itemAt(o),c=a.first;c.type()!==_.External&&(s=(a=a.second).coefficientFor(t))<0&&(a=-a.constant()/s)<e&&(e=a,r=c)}return r},b.prototype._getMarkerLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=e,i=e,e=S,o=e,n=e,s=e,a=this._rowMap,c=0,p=a.size();c<p;++c){var u,h=a.itemAt(c),f=h.second,l=f.coefficientFor(t);0!==l&&((h=h.first).type()===_.External?s=h:l<0?(u=-f.constant()/l)<r&&(r=u,o=h):(u=f.constant()/l)<i&&(i=u,n=h))}return o!==e?o:n!==e?n:s},b.prototype._removeConstraintEffects=function(t,e){e.marker.type()===_.Error&&this._removeMarkerEffects(e.marker,t.strength()),e.other.type()===_.Error&&this._removeMarkerEffects(e.other,t.strength())},b.prototype._removeMarkerEffects=function(t,e){var r=this._rowMap.find(t);void 0!==r?this._objective.insertRow(r.second,-e):this._objective.insertSymbol(t,-e)},b.prototype._anyPivotableSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var o=e.itemAt(r),n=o.first.type();if(n===_.Slack||n===_.Error)return o.first}return S},b.prototype._makeSymbol=function(t){return new M(t,this._idTick++)},b);function b(){this.maxIterations=1e3,this._cnMap=f(),this._rowMap=f(),this._varMap=f(),this._editMap=f(),this._infeasibleRows=[],this._objective=new g,this._artificial=null,this._idTick=0}function w(t){return t<0?-t<1e-8:t<1e-8}(u=_=_||{})[u.Invalid=0]="Invalid",u[u.External=1]="External",u[u.Slack=2]="Slack",u[u.Error=3]="Error",u[u.Dummy=4]="Dummy";E.prototype.id=function(){return this._id},E.prototype.type=function(){return this._type};var M=E;function E(t,e){this._id=e,this._type=t}var S=new M(_.Invalid,-1),g=(x.prototype.cells=function(){return this._cellMap},x.prototype.constant=function(){return this._constant},x.prototype.isConstant=function(){return this._cellMap.empty()},x.prototype.allDummies=function(){for(var t=this._cellMap,e=0,r=t.size();e<r;++e)if(t.itemAt(e).first.type()!==_.Dummy)return!1;return!0},x.prototype.copy=function(){var t=new x(this._constant);return t._cellMap=this._cellMap.copy(),t},x.prototype.add=function(t){return this._constant+=t},x.prototype.insertSymbol=function(t,e){void 0===e&&(e=1),w(this._cellMap.setDefault(t,function(){return 0}).second+=e)&&this._cellMap.erase(t)},x.prototype.insertRow=function(t,e){this._constant+=t._constant*(e=void 0===e?1:e);for(var r=t._cellMap,i=0,o=r.size();i<o;++i){var n=r.itemAt(i);this.insertSymbol(n.first,n.second*e)}},x.prototype.removeSymbol=function(t){this._cellMap.erase(t)},x.prototype.reverseSign=function(){this._constant=-this._constant;for(var t=this._cellMap,e=0,r=t.size();e<r;++e){var i=t.itemAt(e);i.second=-i.second}},x.prototype.solveFor=function(t){var e=this._cellMap,r=-1/e.erase(t).second;this._constant*=r;for(var i=0,o=e.size();i<o;++i)e.itemAt(i).second*=r},x.prototype.solveForEx=function(t,e){this.insertSymbol(t,-1),this.solveFor(e)},x.prototype.coefficientFor=function(t){t=this._cellMap.find(t);return void 0!==t?t.second:0},x.prototype.substitute=function(t,e){t=this._cellMap.erase(t);void 0!==t&&this.insertRow(e,t.second)},x);function x(t){void 0===t&&(t=0),this._cellMap=f(),this._constant=t}d.Constraint=c,d.Expression=y,d.Solver=m,d.Strength=v,d.Variable=l,Object.defineProperty(d,"__esModule",{value:!0})});
